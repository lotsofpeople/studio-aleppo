<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="aleppo-filter.html">
<link rel="import" href="aleppo-citizen-grid.html">

<!--
`aleppo-browse-citizens`


@demo demo/aleppo-browse-citizens.html
-->

<dom-module id="aleppo-browse-citizens">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      [hidden] {
        display: none!important;
      }

      aleppo-citizen-grid {
        padding: 10px;
      }
    </style>

    <aleppo-filter
      api-endpoint="[[apiEndpoint]]"
      active-tags="{{activeTags}}"
      studio-locations="[[studioLocations]]"
      studio-location="{{studioLocation}}"
      migration-years="[[migrationYears]]"
      migration-year="{{migrationYear}}"
    ></aleppo-filter>

    <aleppo-citizen-grid
      api-endpoint="[[apiEndpoint]]"
      citizens-data="[[filteredCitizens]]"
    ></aleppo-citizen-grid>

  </template>

  <script>
    Polymer({

      is: 'aleppo-browse-citizens',

      properties: {
        
        apiEndpoint: {
          type: String
        },
        
        citizensData: {
          type: Array,
          value: []
        },

        filteredCitizens: {
          type: Array,
          value: [],
        },

        activeTags: {
          type: Array,
          value: []
        },

        studioLocations: {
          type: Array,
          computed: '_computeStudioLocations(citizensData.*)'
        },

        studioLocation: {
          type: String,
          value: null
        },

        migrationYears: {
          type: Array,
          computed: '_computeMigrationYears(citizensData.*)'
        },

        migrationYear: {
          type: String,
          value: null
        },

      },

      observers: [
        '_filterCitizens(citizensData.*, activeTags.*, studioLocation, migrationYear)',
        '_filterCitizensChanged(filteredCitizens.splices)'
      ],

      _filterCitizens: function(citizensDataChange, activeTagsChange, studioLocation, migrationYear) {
        var citizensData = citizensDataChange.base;
        var activeTags = activeTagsChange.base;

        //if no tags are active and studioLocationa and migrationYear are not set, simply return entire array
        if(activeTags.length === 0 && !studioLocation && !migrationYear) {
          return this.set('filteredCitizens', citizensData);
        }

        var filteredCitizens = citizensData.filter(function(citizenData) {

          //a. check if there are any matches between activeTags and citizenTags
          var citizenTags = citizenData.tags;
          var citizenTagsMatches = citizenTags.filter(function(tagId) {
            return activeTags.indexOf(tagId) !== -1;
          })
          var citizenHasTagMatches = activeTags.length === 0 || citizenTagsMatches.length > 0;

          //b. check if active studioLocation == citizenLocation
          var citizenStudioLocationMatches = !studioLocation || (studioLocation.toLowerCase() === citizenData.portrait_location.toLowerCase());

          //c. check if active migrationYear == citizenMigrationYear
          var citizenMigrationYearMatches = !migrationYear || (migrationYear == citizenData.migration_date.substr(0, 4));

          var citizenMatches = (citizenHasTagMatches && citizenStudioLocationMatches && citizenMigrationYearMatches);

          return citizenMatches;
        })

        this.set('filteredCitizens', filteredCitizens);
      },

      _filterCitizensChanged: function(filteredCitizensSplice) {
        console.info('_filterCitizensChanged', this.filteredCitizens);
      },

      _computeStudioLocations: function(citizensDataChange) {
        var citizensData = citizensDataChange.base;
        var citizensStudioLocations = citizensData.map(function(citizenData) {
          return citizenData.portrait_location;
        })
        var studioLocations = citizensStudioLocations.filter(this._unique);
        studioLocations = studioLocations.sort(function(a, b) {
          return (a < b) ? -1 : 1;
        })
        return studioLocations;
      },

      _computeMigrationYears: function(citizensDataChange) {
        var citizensData = citizensDataChange.base;
        var citizensStudioMigrationYears = citizensData.map(function(citizenData) {
          return parseInt(citizenData.migration_date.substr(0, 4));
        })
        var migrationYears = citizensStudioMigrationYears.filter(this._unique);
        migrationYears = migrationYears.sort(function(a, b) {
          return (a < b) ? -1 : 1;
        })
        return migrationYears;
      },

      _unique: function(value, index, self) { 
        return self.indexOf(value) === index;
      }

    });
  </script>
</dom-module>