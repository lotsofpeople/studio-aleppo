<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-query.html">
<link rel="import" href="aleppo-button.html">
<link rel="import" href="aleppo-styles.html">
<link rel="import" href="aleppo-speech-balloon.html">
<link rel="import" href="aleppo-citizen-card.html">
<link rel="import" href="../polymerfire/firebase-auth.html">

<!--
`aleppo-curate-citizens`


@demo demo/aleppo-curate-citizens.html
-->

<dom-module id="aleppo-curate-citizens">
  <template>
    <style include="aleppo-styles">
      :host {
        display: block;
        position: fixed;
        height: calc(100% - 108px);
        width: 100%;
        background-color: #10364B;        
      }

      main, section, aleppo-citizen-card{
        height: 100%;
      }

      #intro-screen-container {
        padding: 28px;
        overflow: scroll;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;        
      }

      article {
        color: #ffffff;
        @apply --aleppo-font-body-sans;
        flex: 1;
        max-width: 788px;
      }

      footer {
        width: 100%;
        box-sizing: border-box;
        position:fixed;
        bottom: 40px;
        z-index: 2;
        padding: 0 16px;

        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 10px;
      }

      aleppo-speech-balloon {
        margin-top: -30px;
      }

      aleppo-button {
        width: 100%;          
      }

      #add-friend-button {
        --button-background-color: #FFE57B;        
         grid-column: 1 / 2;  
        grid-row: 1 / 2;
        grid-column-start: 1; 
        grid-column-end: 3;         
      }          
      
      #next-quote-button {
        --button-background-color: #FFFFFF;
      }

      #my-gallery-button {
        --button-background-color: #FF5454;
        --button-color: #FFFFFF;
      }      

      #my-gallery-container[sole-button] {
        grid-column: 1 / 2;  
        grid-row: 1 / 2;        
        grid-column-start: 1; 
        grid-column-end: 3;   
      }

      @media screen and (min-width: 1025px) {
        #intro-screen-container {
          max-width: 1296px;
          padding: 104px 16px;
          margin: auto;
        }

        footer {
          grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
          max-width: 1296px;
          padding: 0 16px;
          left:50%;
          transform: translateX(-50%);
        }

        #start-gallery-button {
          flex:0;
          width: 300px;
        }
        #add-friend-button {
          --button-background-color: #FFE57B;        
          grid-column: 1 / 5;  
          grid-row: 1 / 1;
          grid-column-start: 1; 
          grid-column-end: 1;         
        }
        #next-quote-button {
          grid-column-start: 2; 
          grid-column-end: 2;                   
        }
        #my-gallery-container {
          grid-column-start: 5; 
          grid-column-end: 5;                   
        }        
        #my-gallery-container[sole-button] {
          grid-column-start: 5; 
          grid-column-end: 5;  
        }        
        
      }

      [hidden] {
        display: none!important;
      }
    </style>

    <firebase-auth
      id="auth" 
      user="{{user}}" 
      signed-in="{{signedIn}}"      
    ></firebase-auth>

    <firebase-query
      path="/evaluated-citizens/[[user.uid]]"
      data="{{userEvaluatedCitizens}}"
    ></firebase-query>

    <firebase-query
      path="/galleries/[[user.uid]]"
      data="{{userGallery}}"
    ></firebase-query> 

    <main>
      <template is="dom-if" if="[[_showCurateIntroSection]]" restamp="true">
        <section id="intro-screen-container">
          <article>

            <p>Don’t trust first impressions. They’re often wrong. We judge on looks, clothes, background, religion, color, vocaburary. What if we take that away and force you to pick friends based on their interests, dream and hopes?</p> 

            <p>Studio Aleppo brings together citizens from cities across Europe. Born and raised there, or forced to leave their home country and building up a new life in a different city.</p>

            <p>Tap the button below to curate your personal gallery of new friends, based on the quotes you like most. The portraits will be revealed once you've collected 5 quotes.</p>
          </article>

          <aleppo-button
            id="start-gallery-button"
            text="Make new friends"
            on-tap="_handleMakeNewFriendsButtonTapped"
          ></aleppo-button>        
        </section>
      </template>

      <template is="dom-if" if="[[_showCurateCitizenSection]]" restamp="true">
        <section>
          <aleppo-citizen-card
            citizen-name="[[currentCitizen.title]]"
            quote="[[currentCitizen.quote]]"
            image="[[currentCitizen.portrait_url]]"
            anonymous
          ></aleppo-citizen-card>

          <footer>
            <aleppo-button
              id="add-friend-button"
              text="Add friend to gallery"
              on-tap="_handleAddCitizenToGalleryAttempt"
              hidden$="[[_lastCitizenEvaluated]]"
            ></aleppo-button>

            <aleppo-button
              id="next-quote-button"
              text="Next quote"
              on-tap="_handleNextCitizenAttempt" 
              hidden$="[[_lastCitizenEvaluated]]"                                           
            ></aleppo-button>      

            <div id="my-gallery-container" sole-button$="[[_lastCitizenEvaluated]]">
              <aleppo-speech-balloon 
                hidden$="[[!_showGalleryViewableSpeechBalloon]]"
                text="[[galleryVisibleSpeechBalloonText]]"
                on-tap="hideSpeechBalloon"
              ></aleppo-speech-balloon>

              <aleppo-speech-balloon 
                hidden$="[[!_lastCitizenEvaluated]]"
                text="[[allCitizensEvaluatedSpeechBalloonText]]"
              ></aleppo-speech-balloon>            

                <aleppo-button
                  id="my-gallery-button"              
                  text="My gallery"
                  number="[[userGalleryLength]]"
                  on-tap="_handleGalleryButtonTapped"
                  show-number      
                ></aleppo-button>
            </div>
          </footer>
        </section>
      </template>
      
    </main>    

  </template>
  <script>
    Polymer({

      is: 'aleppo-curate-citizens',
      properties: {
        apiEndpoint: {
          type: String
        },

        user: {
          type: Object,
          value: {}
        },

        signedIn: {
          type: Boolean,
          observer: '_handleSignedInChanged'
        },

        citizensData: {
          type: Array
        },

        allCitizensIds: {
          type: Array,
          value: []
        },

        userGallery: {
          type: Array,
        },

        userGalleryLength: {
          type: Number,
          value: 0
        },

        remainingCitizenIds: {
          type: Array,
          value: []
        },

        userEvaluatedCitizens: {
          type: Array,
          value: []
        },

        databaseRef: {
          type: Object,
          value: {},
          notify: true
        },

        currentCitizenId: {
          type: String,
          observer: '_setEvaluatedCitizenInDatabase'
        }, 

        currentCitizen: {
          type: Object,
          computed: '_setCitizen(currentCitizenId)'
        },         

        galleryVisibleSpeechBalloonText: {
          type: String,
          value: "Great! Your collection is now visible. Now it's time to checkout your gallery and get to know the people behind the quotes."
        },

        allCitizensEvaluatedSpeechBalloonText: {
          type: String,
          value: "Great! You've seen all citizens for now. Check back later to add more to your gallery!"
        },        

        _showGalleryViewableSpeechBalloon: {
          type: Boolean,
          value: false,
          computed: ''
        },

        _showCurateIntroSection: {
          type: Boolean,
          value: false
        },

        _showCurateCitizenSection: {
          type: Boolean,
          value: false
        },        

        _noNextCitizenAvailable: {
          type: Boolean,
          value: false
        },

        _lastCitizenEvaluated: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        '_setCitizenIds(citizensData.splices)',
        '_setRemainingCitizenIds(allCitizensIds.splices, userEvaluatedCitizens.*)',
        '_setUserGalleryLength(userGallery.splices)',
        '_setCurrentCitizenEvaluatedToSignedInUser(user.uid)',
        '_computeShowGalleryViewableSpeechBalloon(userGalleryLength)',
        '_handleRemainingCitizensChanged(remainingCitizenIds.splices)',
        
      ],

      setNextCitizenId: function () {
        var remainingCitizenIds = this.remainingCitizenIds;

        // Get random Id from filteredCitizensIds
        var newCitizenId = remainingCitizenIds[Math.floor(
          Math.random() * remainingCitizenIds.length)
        ];

        // TODO if (!newCitizenId)
        this.set('currentCitizenId', newCitizenId);
      },

      signInAnonymously: function () {
        if(this.signedIn == true) return;

        firebase.auth().signInAnonymously().catch( 
          console.log('error signing in')
        );
      },      

      hideSpeechBalloon: function () {
        this.set('_showGalleryViewableSpeechBalloon', false);
      },

      _handleAddCitizenToGalleryAttempt: function () {
        if(!this.user.uid || !this.currentCitizenId) return;
        firebase.database().ref().child('galleries/' + this.user.uid + '/' + this.currentCitizenId).set(true);
        if(this._noNextCitizenAvailable) return this._handleLastCitizenEvaluated();        
        this.setNextCitizenId();
      },

      _handleNextCitizenAttempt: function () {
        if(this._noNextCitizenAvailable) return this._handleLastCitizenEvaluated();
        this.setNextCitizenId();
      },

      _setRemainingCitizenIds: function (allCitizensIdsSplices, userEvaluatedCitizensSplices) {
        var allCitizensIds = this.allCitizensIds;
        var userEvaluatedCitizens = this.userEvaluatedCitizens;

        // get Ids from Firebase Array with $key, $val.
        var evaluatedCitizensIds = userEvaluatedCitizens.map(function(a) {
          return parseInt(a.$key)
        });
  
        // Filter out Ids from allCitizensIds that are in evaluatedCitizensIds.
        var unevaluatedCitizensIds = allCitizensIds.filter(function(citizenId) {
          return evaluatedCitizensIds.indexOf(citizenId) === -1;
        });        

        this.set('remainingCitizenIds', []);
        for(var i = 0; i < unevaluatedCitizensIds.length; i++) {
          this.push('remainingCitizenIds', unevaluatedCitizensIds[i]);
        }

        if(!this.currentCitizenId && unevaluatedCitizensIds.length > 0) this.setNextCitizenId();
      },

      _handleRemainingCitizensChanged: function () {
        (this.remainingCitizenIds.length === 0) ? this.set('_noNextCitizenAvailable', true) : this.set('_noNextCitizenAvailable', false);
      },

      _handleLastCitizenEvaluated: function () {
        this.set('_lastCitizenEvaluated', true);
      },     

      _setCitizen: function (currentCitizenId) {
        var allCitizens = this.citizensData;
        //  Find index of currentCitizenId from allCitizens Array.
        var index = allCitizens.findIndex(x => x.id==currentCitizenId);
        // Get Object of currentCitizen
        var currentCitizen = allCitizens[index] || {};
        return currentCitizen;
      },

      _setEvaluatedCitizenInDatabase: function () {
        if(!this.signedIn || !this.user || !this.currentCitizenId) return;  
        firebase.database().ref().child('evaluated-citizens/' + this.user.uid + '/' + this.currentCitizenId).set(true);
      },

      _setCitizenIds: function (citizensDataSpliced) {
        var citizensData = this.citizensData;
        var citizensIds = citizensData.map(function(a) {return a.id;});

        this.set('allCitizensIds', []);
        for(var i = 0; i < citizensIds.length; i++) {
          this.push('allCitizensIds', citizensIds[i]);
        }
      },

      _setUserGalleryLength: function (userGallerySplices) {
        var galleryLength = this.userGallery.length ? this.userGallery.length : 0;
        this.set('userGalleryLength', galleryLength);
      },

      _computeShowGalleryViewableSpeechBalloon: function (galleryLength) {
        if (galleryLength == 5) return this.set('_showGalleryViewableSpeechBalloon', true);
        this.hideSpeechBalloon();
      },

      _handleMakeNewFriendsButtonTapped: function () {
        if(!this.signedIn) return this.signInAnonymously();        
      },

      _handleSignedInChanged: function (signedIn) {
        if(signedIn) {
          this.set('_showCurateIntroSection', false);        
          this.set('_showCurateCitizenSection', true);
        } else {
          this.set('_showCurateIntroSection', true);        
          this.set('_showCurateCitizenSection', false);
        }
      },

      _setCurrentCitizenEvaluatedToSignedInUser: function (userId) {
        if(userId) this._setEvaluatedCitizenInDatabase();
      },

      _handleGalleryButtonTapped: function () {
        var a = document.createElement('a');
        a.href = "#/galleries/" + this.user.uid;
        a.click();
        delete a;
      }
    });
  </script>
</dom-module>