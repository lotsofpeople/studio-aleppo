<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-query.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="aleppo-citizen-grid.html">
<link rel="import" href="aleppo-citizen-detail-page.html">

<!--
`aleppo-personal-gallery`


@demo demo/aleppo-personal-gallery.html
-->

<dom-module id="aleppo-personal-gallery">
  <template>
    <style>
      :host {
        display: block;
      }

      [hidden] {
        display: none!important;
      }
      
      aleppo-citizen-detail-page {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        transition: 0.3s opacity;
        opacity: 0;
        pointer-events: none;
      }

      aleppo-citizen-detail-page[data-active] {
        opacity: 1;
        pointer-events: all;
      }

      #close-detail-page-button {
        position: fixed;
        top: 0;
        right: 0;
        z-index: 4;
        transition: 0.3s opacity;
        opacity: 0;
        pointer-events: none;        
      }

      #close-detail-page-button[data-active] {
        opacity: 1;
        pointer-events: all;        
      }      
    </style>

    <firebase-query
      path="/galleries/[[galleryId]]"
      data="{{galleryCitizenIds}}"
    ></firebase-query>

    <aleppo-citizen-grid
      citizens-data="[[galleryCitizensData]]"
      show-all-citizens-anonymous="[[!galleryReachedMinimumLength]]"
      on-card-tapped="_handleCitizenCardTapped"
    ></aleppo-citizen-grid>

    <aleppo-citizen-detail-page
      api-endpoint="[[apiEndpoint]]"
      data-active$="[[activeCitizen.id]]"
      citizen-data="[[activeCitizen]]"
    ></aleppo-citizen-detail-page>    

    <paper-icon-button
      id="close-detail-page-button"
      icon="close"
      data-active$="[[activeCitizen.id]]"
      on-tap="closeDetailPage"
    ></paper-icon-button>
  
  </template>
  <script>
    Polymer({

      is: 'aleppo-personal-gallery',
      properties: {
        galleryId: {
          type: String
        },

        galleryCitizenIds: {
          type: Array,
          value: []
        },

        citizensData: {
          type: Array,
          value: []
        },

        galleryCitizensData: {
          type: Array,
          value: []
        },
        
        userGalleryLength: {
          type: Number,
          value: 0
        },

        activeCitizen: {
          type: Object,
        },

        citizenActive: {
          type: Boolean,
          computed: '_computeCitizenActive(activeCitizen.id)',
          observer: '_citizenActiveChanged'
        },        

        galleryReachedMinimumLength: {
          type: Boolean,
          value: false,
          computed: "_computeGalleryReachedMinimumLength(userGalleryLength)"
        }      
      },
      observers: [
        '_setGalleryCitizens(citizensData.*, galleryCitizenIds.*)',        
        '_setUserGalleryLength(userGallery.splices)',
      ],

      closeDetailPage: function() {
        this.set('activeCitizen', null);
      },

      _setGalleryCitizens: function (allCitizensIdsSplices, galleryCitizenIdsChanged) {
        var galleryCitizenIds = this.galleryCitizenIds;
        var citizensData = this.citizensData;
        
        if(galleryCitizenIds.length > 0) this.set('galleryCitizensData', []);


        for(var i = 0; i < galleryCitizenIds.length; i++) {
          var index = citizensData.findIndex(x => x.id=== parseInt(galleryCitizenIds[i].$key));

          // Get Object of currentCitizen
          var currentCitizen = citizensData[index] || {};          

          this.push('galleryCitizensData', currentCitizen);
        }
      },

      _setUserGalleryLength: function (userGallerySplices) {
        var galleryLength = this.userGallery.length ? this.userGallery.length : 0;
        this.set('userGalleryLength', galleryLength);
      },

      _computeGalleryReachedMinimumLength: function (userGalleryLength) {
        return userGalleryLength > 4;
      },

      _computeCitizenActive: function(activeCitizenId) {
        return !!activeCitizenId;
      },      

      _handleCitizenCardTapped: function(evt, citizenData) {
        this.set('activeCitizen', citizenData);
        this.notifyPath('activeCitizen.id', this.activeCitizen.id);
      },      

      _citizenActiveChanged: function(citizenActive) {
        document.body.style.overflow = (citizenActive) ? 'hidden' : '';
      }      
    });
  </script>
</dom-module>