<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-query.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="aleppo-citizen-grid.html">
<link rel="import" href="aleppo-citizen-detail-page.html">
<link rel="import" href="aleppo-styles.html">

<!--
`aleppo-personal-gallery`


@demo demo/aleppo-personal-gallery.html
-->

<dom-module id="aleppo-personal-gallery">
  <template>
    <style include="aleppo-styles">
      :host {
        display: block;
      }

      [hidden] {
        display: none!important;
      }
      
      aleppo-citizen-detail-page {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        transition: 0.3s opacity;
        opacity: 0;
        pointer-events: none;
      }

      aleppo-citizen-detail-page[data-active] {
        opacity: 1;
        pointer-events: all;
      }

      aleppo-citizen-grid {
        padding: 16px;
      }

      article {
        text-align: center;
        margin-top: 8px;
        @apply --aleppo-font-body;
      }

      footer {
        display: flex;
        flex-direction: row;
        justify-content: center;
      }

      aleppo-button {
        width: 222px;
        margin: 20px;
      }
    </style>

    <firebase-query
      path="/galleries/[[galleryId]]"
      data="{{galleryCitizenIds}}"
    ></firebase-query>

    <firebase-auth
      id="auth" 
      user="{{user}}"
      signed-in="{{signedIn}}"
    ></firebase-auth>
  
    <article hidden$="[[galleryReachedMinimumLength]]">
      Add 5 friends minimum to reveal the photos of your friends.
    </article>

    <aleppo-citizen-grid
      citizens-data="[[galleryCitizensData]]"
      on-card-tapped="_handleCitizenCardTapped"
      show-all-citizens-anonymous="[[!galleryReachedMinimumLength]]"
      cards-are-clickable="[[galleryReachedMinimumLength]]"
    ></aleppo-citizen-grid>

    <footer>
      <template is="dom-if" if="[[_userIsGalleryAuthor(user.uid, galleryId)]]">
        <aleppo-button
          on-tap="_handleTapFindMoreFriendsButton"
          text="Find more friends"
        ></aleppo-button>

        <aleppo-button
          on-tap="_handleTapNewGalleryButton"
          text="Start new gallery"
        ></aleppo-button>
      </template> 
    </footer>

    <aleppo-citizen-detail-page
      api-endpoint="[[apiEndpoint]]"
      citizen-id="[[activeCitizen.id]]"
      citizen-data="{{activeCitizen}}"
      data-active$="[[citizenActive]]"
    ></aleppo-citizen-detail-page>
  
  </template>
  <script>
    Polymer({

      is: 'aleppo-personal-gallery',
      properties: {
        galleryId: {
          type: String
        },

        galleryCitizenIds: {
          type: Array,
          value: []
        },

        citizensData: {
          type: Array,
          value: []
        },

        galleryCitizensData: {
          type: Array,
          value: []
        },
        
        galleryLength: {
          type: Number,
          value: 0
        },

        minimumGalleryLength: {
          type: Number,
          value: 5
        },

        galleryReachedMinimumLength: {
          type: Boolean,
          value: false,
          computed: "_computeGalleryReachedMinimumLength(galleryLength)"
        },

        activeCitizen: {
          type: Object,
        },

        citizenActive: {
          type: Boolean,
          computed: '_computeCitizenActive(activeCitizen.id)',
          observer: '_citizenActiveChanged'
        },      

      },
      observers: [
        '_setGalleryCitizens(citizensData.*, galleryCitizenIds.*)',        
        '_setUserGalleryLength(galleryCitizenIds.splices)',
      ],

      navigateToCuratePage: function () {
        var a = document.createElement('a');
        a.href = "/curate";
        a.click();
        delete a;        
      },

      _setGalleryCitizens: function (allCitizensIdsSplices, galleryCitizenIdsChanged) {
        var galleryCitizenIds = this.galleryCitizenIds;
        var citizensData = this.citizensData;
        
        if(galleryCitizenIds.length > 0) this.set('galleryCitizensData', []);


        for(var i = 0; i < galleryCitizenIds.length; i++) {
          var index = citizensData.findIndex(x => x.id=== parseInt(galleryCitizenIds[i].$key));

          // Get Object of currentCitizen
          var currentCitizen = citizensData[index] || {};          

          this.push('galleryCitizensData', currentCitizen);
        }
      },

      _setUserGalleryLength: function (galleryCitizenIdsSplices) {
        var galleryLength = this.galleryCitizenIds.length ? this.galleryCitizenIds.length : 0;
        this.set('galleryLength', galleryLength);
      },

      _computeGalleryReachedMinimumLength: function (galleryLength) {
        return galleryLength >= this.minimumGalleryLength;
      },

      _computeCitizenActive: function(activeCitizenId) {
        return !!activeCitizenId;
      },      

      _handleCitizenCardTapped: function(evt, citizenData) {
        if(this.galleryReachedMinimumLength) this.set('activeCitizen', citizenData);
      },      

      _citizenActiveChanged: function(citizenActive) {
        document.body.style.overflow = (citizenActive) ? 'hidden' : '';
      },

      _userIsGalleryAuthor: function (userId, galleryId) {
        return userId === galleryId;
      },

      _handleTapFindMoreFriendsButton: function () {
        this.navigateToCuratePage()
      },

      _handleTapNewGalleryButton: function () {
        var doStartNewGallery = window.confirm('You cannot alter your current gallery after start a new one. Are you sure you want to start a new gallery?');
        if(!doStartNewGallery) return;
        this.$.auth.signOut();
        this.navigateToCuratePage();
      }
    });
  </script>
</dom-module>